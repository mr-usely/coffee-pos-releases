name: Create Release

on:
  repository_dispatch:
    types: [new-release]

permissions:
  contents: write

jobs:
  release:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout releases repo
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
      
      - name: Download APK from main repo
        uses: actions/download-artifact@v4
        with:
          github-token: ${{ secrets.MAIN_REPO_TOKEN }}
          run-id: ${{ github.event.client_payload.run_id }}
          repository: mr-usely/coffee-pos
          name: app-release-${{ github.event.client_payload.version }}
          path: ./temp
          
      - name: Setup release directory
        run: |
          VERSION="${{ github.event.client_payload.version }}"
          echo "Setting up release for version: $VERSION"
          mkdir -p releases/$VERSION
          mv temp/app-release.apk releases/$VERSION/
          ls -lh releases/$VERSION/
          
      - name: Generate CHANGELOG
        run: |
          VERSION="${{ github.event.client_payload.version }}"
          COMMIT_MSG="${{ github.event.client_payload.commit_message }}"
          
          cat > releases/$VERSION/CHANGELOG.md << EOF
          # Release $VERSION
          
          ## Changes
          $COMMIT_MSG
          
          ## Release Date
          $(date -u +"%Y-%m-%dT%H:%M:%SZ")
          
          ## Commit
          [${{ github.event.client_payload.commit_sha }}](https://github.com/mr-usely/coffee-pos-saas/commit/${{ github.event.client_payload.commit_sha }})
          EOF
          
          cat releases/$VERSION/CHANGELOG.md
          
      - name: Create GitHub Release
        id: create_release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: v${{ github.event.client_payload.version }}
          name: Release ${{ github.event.client_payload.version }}
          body_path: releases/${{ github.event.client_payload.version }}/CHANGELOG.md
          files: releases/${{ github.event.client_payload.version }}/app-release.apk
          draft: false
          prerelease: false
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          
      - name: Get Asset ID and Update latest.json
        run: |
          VERSION="${{ github.event.client_payload.version }}"
          BUILD_NUMBER=$(echo $VERSION | cut -d'+' -f2)
          FILE_SIZE=$(stat -c%s releases/$VERSION/app-release.apk 2>/dev/null || stat -f%z releases/$VERSION/app-release.apk)
          COMMIT_MSG="${{ github.event.client_payload.commit_message }}"
          
          # Get the release ID and fetch asset ID
          RELEASE_TAG="v$VERSION"
          ASSET_ID=$(curl -s -H "Authorization: token ${{ secrets.GITHUB_TOKEN }}" \
            "https://api.github.com/repos/mr-usely/coffee-pos-releases/releases/tags/${RELEASE_TAG}" | \
            jq -r '.assets[] | select(.name == "app-release.apk") | .id')
          
          echo "Asset ID: $ASSET_ID"
          
          # Escape newlines and quotes in commit message for JSON
          RELEASE_NOTES=$(echo "$COMMIT_MSG" | sed 's/"/\\"/g' | sed ':a;N;$!ba;s/\n/\\n/g')
          
          # Use GitHub API URL for private repo downloads
          cat > latest.json << EOF
          {
            "version": "$VERSION",
            "versionCode": $BUILD_NUMBER,
            "downloadUrl": "https://api.github.com/repos/mr-usely/coffee-pos-releases/releases/assets/${ASSET_ID}",
            "releaseNotes": "$RELEASE_NOTES",
            "releaseDate": "$(date -u +"%Y-%m-%dT%H:%M:%SZ")",
            "minSupportedVersion": "1.0.0+5",
            "fileSize": $FILE_SIZE
          }
          EOF
          
          echo "Updated latest.json:"
          cat latest.json
          
      - name: Commit changes
        run: |
          VERSION="${{ github.event.client_payload.version }}"
          git config user.name "GitHub Actions Bot"
          git config user.email "actions@github.com"
          git add releases/$VERSION/ latest.json
          git commit -m "Release v$VERSION" || echo "No changes to commit"
          git push
          

